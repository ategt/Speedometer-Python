<!DOCTYPE html>
<html>
<head>
	<title>HIIT MON</title>
	<script type="text/javascript" src="./send/socket.io.js"></script>
	<script type="text/javascript" src="./send/d3.v6.js"></script>
	<script type="text/javascript" src="./send/axios.min.js"></script>
	<script type="text/javascript">
    	const NUMBER_REGEX = new RegExp("b\\'([\\d]+)");
		const socket = io();
		let clock_started = false;

		window.addEventListener("load", function (event) {
			const make_fullscreen = function (element) {
			     if (element.requestFullscreen) {
			      element.requestFullscreen();
			    } else if (element.mozRequestFullScreen) {
			      element.mozRequestFullScreen();
			    } else if (element.webkitRequestFullscreen) {
			      element.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
			    } else if (element.msRequestFullscreen) {
			      element.msRequestFullscreen();
			    }
			};

			const close_fullscreen = function () {
			     if (document.exitFullscreen) {
			          document.exitFullscreen();
			        } else if (document.mozCancelFullScreen) {
			          document.mozCancelFullScreen();
			        } else if (document.webkitExitFullscreen) {
			          document.webkitExitFullscreen();
			        } else if (document.msExitFullscreen) {
			          document.msExitFullscreen();
			        }
			};

			const is_fullscreen = function () {
			    return (
			        document.fullscreenElement ||
			        document.webkitFullscreenElement ||
			        document.mozFullScreenElement ||
			        document.msFullscreenElement
			      );
			};

			const element = document.getElementsByClassName("info-banner-panel")[0];

			element.addEventListener("fullscreenchange", function (event) {
			    if (is_fullscreen())   {
			        element.classList.add("fullscreen");
			    } else {
			        element.classList.remove("fullscreen");
			    }
			});

			const start_timer = function() {
				socket.emit('tabata timer action', {data:"START"});
			};

			const stop_timer = function() {
				socket.emit('tabata timer action', {data:"STOP"});
			};

			const reset_timer = function() {
				socket.emit('tabata timer action', {data:"STOP"});
				clock_started = false;
			};

			document.getElementById("fullscreen-button").addEventListener("click", function (event) {
				make_fullscreen(element);
			});

			document.getElementById("start-timer-button").addEventListener("click", function (event) {
				start_timer();
			});

			document.getElementById("stop-timer-button").addEventListener("click", function (event) {
				stop_timer();
			});

			document.getElementById("reset-timer-button").addEventListener("click", function (event) {
				reset_timer();
			});

			const format_time = function (count) {
				if (count === " - ") { return count; }
			    const seconds = count % 60;
			    const minutes = Math.floor(count / 60);
			    
			    const min_str = minutes < 10 ? `0${minutes}` : `${minutes}`;
			    const sec_str = seconds < 10 ? `0${seconds}` : `${seconds}`;

			    return `${min_str}:${sec_str}`;
			};

			socket.on('speedometer update broadcast', function(msg) {
				// Log broadcast to recieving field.
	        	const el = document.getElementById("recieved");
	        	const divElement = document.createElement("div");

	        	divElement.innerText = JSON.stringify(msg.data);
	        	el.appendChild(divElement);	        	
	        });

			socket.on('speedometer update broadcast', function(msg) {
				// Update RPM speed field.
	        	const el = document.getElementById("speed-banner");
	        	const headingElement = document.createElement("h2");

	        	headingElement.innerText = `${msg.data.currentRevsPerMin} RPMs`;
	        	el.replaceChildren(headingElement);
	    	});

			socket.on('speedometer update broadcast', function(msg) {
				// If the clock is not running, and the bike is,
				// start the clock.
				if (!clock_started && +msg.data.currentRevsPerMin > 0) {
					clock_started = true;
					socket.emit('tabata timer action', {data:"START"});
				} else {
					// Timer process seems to suspend at about 2:30 and
					// this code keeps it alive. Not sure why that is.
					socket.emit('tabata timer action', {data:"PID"});
				}
	    	});

			socket.on('tabata timer update broadcast', function(msg) {
				// Update Time Remaining field.
	        	const el = document.getElementById("timer-banner");
	        	const headingElement = document.createElement("h2");

	        	headingElement.innerText = format_time(msg.data.timeRemaining);
	        	el.replaceChildren(headingElement);
	    	});

			socket.on('tabata timer update broadcast', function(msg) {
				// Update activity field.
	        	const el = document.getElementById("activity-banner");
	        	const headingElement = document.createElement("h2");

	        	headingElement.innerText = `${msg.data.activity}`;
	        	el.replaceChildren(headingElement);
	    	});

			socket.on('tabata timer update broadcast', function(msg) {
				// Log broadcast to recieving field.
	        	const el = document.getElementById("recieved");
	        	const divElement = document.createElement("div");

	        	divElement.innerText = JSON.stringify(msg.data);
	        	el.appendChild(divElement);
	        });

	        socket.on('tabata timer update broadcast', function(msg) {
				// If timer runs out, exit fullscreen.
	        	if (msg.data.timeRemaining === " - " && is_fullscreen()) {
	        		close_fullscreen();
	        	}
	    	});

	        socket.on('tabata timer update broadcast', function(msg) {
				// If timer is running, mark variable as running.
				if (!clock_started && msg.data.timeRemaining !== " - ") {
	    			clock_started = true;
	    		}
	    	});

	    	socket.on('tabata timer action broadcast', function(msg) {
				// Log broadcast to recieving field.
	        	const el = document.getElementById("recieved");
	        	const divElement = document.createElement("div");

	        	divElement.innerText = JSON.stringify(msg.data);
	        	el.appendChild(divElement);	        	
	        });
		});
	</script>
	<style type="text/css">
		textarea {
		    height: 10em;
    		width: 18em;
		}
		.input-wrapper {
		    display: grid;
    		margin: 9px;
    		grid-gap: 8px;
		}
		.input-fields {
			display: flex;
    		flex-flow: wrap;
		}
		.recieved-field {
		    height: 14em;
		    /*width: 36em;*/
		    /*border: 1px solid black;*/
		    padding: 5px;
		    overflow-y: overlay;
		}
		.info-banner-panel {
			width: 100%;
		    font-size: +4em;
		    text-align: center;
		}
		.info-banner-panel h2 {
		    padding: 0px;
		    margin-block: 0px;
		    margin: 0px;
		    margin-inline: 0px;
		}
		.label {
			font-size: large;
		}
		.graph-link-panel {
		    width: -webkit-fill-available;
    		text-align: right;
		}
		.fullscreen {
			background-color: white;
		}
		.fullscreen > .label {
			display: none;
		}
		.fullscreen > .info-banner {
			font-size: 9rem;
		}
		.sub-banner {
			display: flex;
		}
		.right-pane {
			text-align: right;
    		padding-right: 4rem;
    		display: inline-flex;
		}
		.timer-button {
			background-color: lightgrey;
			font-size: 1.5em;
    		font-weight: bold;
    		text-align: center;
    		margin: 0.5rem;
    		padding: 0px;
		}
		.fullscreen-button-span {
			width: inherit;
		}
	</style>
	<style type="text/css">
		/* tell the SVG path to be a thin blue line without an area fill */
		path {
			/*stroke: steelblue;*/
			/*stroke-width: 1.5;*/
			/*fill: none;*/
			stroke-linejoin: round;
      		stroke-linecap: round;
		}

		.axis {
			shape-rendering: crispEdges;
		}

		.x.axis line {
			stroke: lightgrey;
		}

		.x.axis .minor {
			stroke-opacity: 0.5;
		}

		.x.axis path {
			display: none;
		}

		.y.axis line, .y.axis path {
			fill: none;
			stroke: orange;
		}
		.title-banner {
			display: flex;
    		width: 95%;
		}
		.title-panel, .graph-link-panel, .half-pane {
			width: 50%;
		}
		.graph-link-panel, .no-decoration {
		    text-decoration: none;
    		color: unset;
		}
		.graph-link-panel a {
		    text-decoration: none;
    		color: unset;
		}
	</style>
</head>
<body>
	<div class="title-banner">
		<div class="title-panel">
			<h1>HIIT MON</h1>
		</div>
		<div class="graph-link-panel">
			<h1>
				<a href="./d3" id="graph-link" class="no-decoration">GRAPH</a>
			</h1>
		</div>
	</div>
	<div class="info-banner-panel" id="info-panel">
		<div class="label speed">
			Speed
		</div>
		<div class="info-banner speed-banner" id="speed-banner">
			<h2>-</h2>
		</div>
		<div class="label time-remaining">
			Time Remaining
		</div>
		<div class="info-banner timer-banner" id="timer-banner">
			<h2>-</h2>
		</div>
		<div class="label current-activity">
			Activity
		</div>
		<div class="info-banner activity-banner" id="activity-banner">
			<h2>-</h2>
		</div>
	</div>
	<div class="recieve-area">
		<div class="sub-banner receive-sub-banner">
			<div class="half-pane left-pane">
				<h2>Received:</h2>
			</div>
			<div class="half-pane right-pane">
				<div id="start-timer-button" class="timer-button">
					START TIMER
				</div>
				<div id="stop-timer-button" class="timer-button">
					STOP TIMER
				</div>
				<div id="reset-timer-button" class="timer-button">
					RESET TIMER
				</div>
				<h2>
					<span class="fullscreen-button-span">
						<a id="fullscreen-button" class="no-decoration">FULL&nbsp;SCREEN</a>
					</span>
				</h2>
			</div>			
		</div>
		<div id="recieved" class="recieved-field"></div>
	</div>
</body>
</html>